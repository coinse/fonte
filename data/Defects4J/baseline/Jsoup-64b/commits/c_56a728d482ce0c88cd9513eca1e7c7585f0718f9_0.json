{"sha": "56a728d482ce0c88cd9513eca1e7c7585f0718f9", "log": "Fix double escaping of query string in redirect", "commit": "\n--- a/src/main/java/org/jsoup/helper/HttpConnection.java\n+++ b/src/main/java/org/jsoup/helper/HttpConnection.java\n \tprivate static URL encodeUrl(URL u) {\n         try {\n             //  odd way to encode urls, but it works!\n-            final URI uri = new URI(u.getProtocol(), u.getUserInfo(), u.getHost(), u.getPort(), u.getPath(), u.getQuery(), u.getRef());\n+            final URI uri = new URI(u.toExternalForm());\n             return new URL(uri.toASCIIString());\n         } catch (Exception e) {\n             return u;\n--- a/src/test/java/org/jsoup/integration/UrlConnectTest.java\n+++ b/src/test/java/org/jsoup/integration/UrlConnectTest.java\n \n         assertTrue(body[0].length() > 0);\n     }\n+\n+    @Test public void handlesEscapedRedirectUrls() throws IOException {\n+        String url = \"http://www.altalex.com/documents/news/2016/12/06/questioni-civilistiche-conseguenti-alla-depenalizzazione\";\n+        // sends: Location:http://shop.wki.it/shared/sso/sso.aspx?sso=&url=http%3a%2f%2fwww.altalex.com%2fsession%2fset%2f%3freturnurl%3dhttp%253a%252f%252fwww.altalex.com%253a80%252fdocuments%252fnews%252f2016%252f12%252f06%252fquestioni-civilistiche-conseguenti-alla-depenalizzazione\n+        // then to: http://www.altalex.com/session/set/?returnurl=http%3a%2f%2fwww.altalex.com%3a80%2fdocuments%2fnews%2f2016%2f12%2f06%2fquestioni-civilistiche-conseguenti-alla-depenalizzazione&sso=RDRG6T684G4AK2E7U591UGR923\n+        // then : http://www.altalex.com:80/documents/news/2016/12/06/questioni-civilistiche-conseguenti-alla-depenalizzazione\n+\n+        // bug is that jsoup goes to\n+        // \tGET /shared/sso/sso.aspx?sso=&url=http%253a%252f%252fwww.altalex.com%252fsession%252fset%252f%253freturnurl%253dhttp%25253a%25252f%25252fwww.altalex.com%25253a80%25252fdocuments%25252fnews%25252f2016%25252f12%25252f06%25252fquestioni-civilistiche-conseguenti-alla-depenalizzazione HTTP/1.1\n+        // i.e. double escaped\n+\n+        Connection.Response res = Jsoup.connect(url)\n+                .proxy(\"localhost\", 8888)\n+                .execute();\n+        Document doc = res.parse();\n+        assertEquals(200, res.statusCode());\n+    }\n }", "timestamp": 1485044826, "metainfo": ""}