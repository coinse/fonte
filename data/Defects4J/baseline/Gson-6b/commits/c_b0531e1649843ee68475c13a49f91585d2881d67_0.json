{"sha": "b0531e1649843ee68475c13a49f91585d2881d67", "log": "Ensure \"excluder\" is added prior to user defined type adapters/factories. - Added test expose bad behaviour.", "commit": "\n--- a/gson/src/main/java/com/google/gson/Gson.java\n+++ b/gson/src/main/java/com/google/gson/Gson.java\n     factories.add(TypeAdapters.JSON_ELEMENT_FACTORY);\n     factories.add(ObjectTypeAdapter.FACTORY);\n \n+    // the excluder must precede all adapters that handle user-defined types\n+    factories.add(excluder);\n+\n     // user's type adapters\n     factories.addAll(typeAdapterFactories);\n \n     factories.add(ArrayTypeAdapter.FACTORY);\n     factories.add(TypeAdapters.ENUM_FACTORY);\n     factories.add(TypeAdapters.CLASS_FACTORY);\n-\n-    // the excluder must precede all adapters that handle user-defined types\n-    factories.add(excluder);\n \n     // type adapters for composite and user-defined types\n     factories.add(new CollectionTypeAdapterFactory(constructorConstructor));\n \n   @Override\n   public String toString() {\n-  \tStringBuilder sb = new StringBuilder(\"{\")\n-  \t    .append(\"serializeNulls:\").append(serializeNulls)\n+  \treturn new StringBuilder(\"{serializeNulls:\")\n+  \t    .append(serializeNulls)\n   \t    .append(\"factories:\").append(factories)\n         .append(\",instanceCreators:\").append(constructorConstructor)\n-        .append(\"}\");\n-  \treturn sb.toString();\n+        .append(\"}\")\n+        .toString();\n   }\n }\n--- a/gson/src/test/java/com/google/gson/functional/ObjectTest.java\n+++ b/gson/src/test/java/com/google/gson/functional/ObjectTest.java\n import com.google.gson.Gson;\n import com.google.gson.GsonBuilder;\n import com.google.gson.InstanceCreator;\n+import com.google.gson.JsonElement;\n import com.google.gson.JsonObject;\n import com.google.gson.JsonParseException;\n+import com.google.gson.JsonSerializationContext;\n+import com.google.gson.JsonSerializer;\n+import com.google.gson.common.TestTypes;\n import com.google.gson.common.TestTypes.ArrayOfObjects;\n import com.google.gson.common.TestTypes.BagOfPrimitiveWrappers;\n import com.google.gson.common.TestTypes.BagOfPrimitives;\n   }\n \n   public void testAnonymousLocalClassesSerialization() throws Exception {\n+    assertEquals(\"null\", gson.toJson(new ClassWithNoFields() {\n+      // empty anonymous class\n+    }));\n+  }\n+\n+  public void testAnonymousLocalClassesCustomSerialization() throws Exception {\n+    gson = new GsonBuilder()\n+        .registerTypeHierarchyAdapter(ClassWithNoFields.class,\n+            new JsonSerializer<ClassWithNoFields>() {\n+              public JsonElement serialize(\n+                  ClassWithNoFields src, Type typeOfSrc, JsonSerializationContext context) {\n+                return new JsonObject();\n+              }\n+            }).create();\n+\n     assertEquals(\"null\", gson.toJson(new ClassWithNoFields() {\n       // empty anonymous class\n     }));", "timestamp": 1356032493, "metainfo": ""}