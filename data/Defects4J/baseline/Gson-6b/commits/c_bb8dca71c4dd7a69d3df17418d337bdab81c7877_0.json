{"sha": "bb8dca71c4dd7a69d3df17418d337bdab81c7877", "log": "Restore ability of instance creators to create collection and map types. We inadvertently lost this in Gson 2.0 and 2.1. Nobody noticed!", "commit": "\n--- a/gson/src/main/java/com/google/gson/Gson.java\n+++ b/gson/src/main/java/com/google/gson/Gson.java\n     this.htmlSafe = htmlSafe;\n     this.prettyPrinting = prettyPrinting;\n \n-    TypeAdapterFactory reflectiveTypeAdapterFactory = new ReflectiveTypeAdapterFactory(\n-        constructorConstructor, fieldNamingPolicy, excluder);\n-\n-    ConstructorConstructor constructorConstructor = new ConstructorConstructor();\n     List<TypeAdapterFactory> factories = new ArrayList<TypeAdapterFactory>();\n \n     // built-in type adapters that cannot be overridden\n     factories.add(ArrayTypeAdapter.FACTORY);\n     factories.add(TypeAdapters.ENUM_FACTORY);\n     factories.add(TypeAdapters.CLASS_FACTORY);\n-    factories.add(reflectiveTypeAdapterFactory);\n+    factories.add(new ReflectiveTypeAdapterFactory(\n+        constructorConstructor, fieldNamingPolicy, excluder));\n \n     this.factories = Collections.unmodifiableList(factories);\n   }\n--- a/gson/src/test/java/com/google/gson/functional/InstanceCreatorTest.java\n+++ b/gson/src/test/java/com/google/gson/functional/InstanceCreatorTest.java\n import com.google.gson.common.TestTypes.ClassWithBaseField;\n import com.google.gson.common.TestTypes.Sub;\n \n+import com.google.gson.reflect.TypeToken;\n+import java.util.ArrayList;\n+import java.util.List;\n import junit.framework.TestCase;\n \n import java.lang.reflect.Type;\n     assertTrue(target.base instanceof Sub);\n     assertEquals(Sub.SUB_NAME, ((Sub)target.base).subName);\n   }\n+\n+  // This regressed in Gson 2.0 and 2.1\n+  public void testInstanceCreatorForCollectionType() {\n+    class SubArrayList<T> extends ArrayList<T> {}\n+    InstanceCreator<List<String>> listCreator = new InstanceCreator<List<String>>() {\n+      public List<String> createInstance(Type type) {\n+        return new SubArrayList<java.lang.String>();\n+      }\n+    };\n+    Type listOfStringType = new TypeToken<List<String>>() {}.getType();\n+    Gson gson = new GsonBuilder()\n+        .registerTypeAdapter(listOfStringType, listCreator)\n+        .create();\n+    List<String> list = gson.fromJson(\"[\\\"a\\\"]\", listOfStringType);\n+    assertEquals(SubArrayList.class, list.getClass());\n+  }\n }", "timestamp": 1325432793, "metainfo": ""}