{"sha": "6e8d3cd65e2777da196513d91b796d3e03e203d1", "log": "Created threadsafe implementation of JsonAdapter invocation. Also fixed a bug where runtime generated typeadapters were being carried over from a toJson/fromJson call to the next.", "commit": "\n--- a/gson/src/main/java/com/google/gson/Gson.java\n+++ b/gson/src/main/java/com/google/gson/Gson.java\n   private final Map<TypeToken<?>, TypeAdapter<?>> typeTokenCache\n       = Collections.synchronizedMap(new HashMap<TypeToken<?>, TypeAdapter<?>>());\n \n+  /** Indicates whether Gson is in the phase of constructor invocation. It is used to determine\n+   * whether to add a constructor in preconfiguredGeneratedTypeAdapter set or not. */\n+  private boolean inConstructorPhase = true;\n+  /** List of type adapters that are generated by Gson during its constructor */\n+  private Set<TypeAdapter<?>> preconfiguredGeneratedTypeAdapters = new HashSet<TypeAdapter<?>>();\n+  /** List of type adapters that are generated by Gson during toJson/fromJson. */\n+  private final ThreadLocal<Set<TypeAdapter<?>>> runtimeGeneratedTypeAdapters =\n+      new ThreadLocal<Set<TypeAdapter<?>>>();\n+\n   private final List<TypeAdapterFactory> factories;\n   private final ConstructorConstructor constructorConstructor;\n \n         constructorConstructor, fieldNamingPolicy, excluder));\n \n     this.factories = Collections.unmodifiableList(factories);\n+    this.preconfiguredGeneratedTypeAdapters = Collections.unmodifiableSet(preconfiguredGeneratedTypeAdapters);\n+    inConstructorPhase = false;\n   }\n \n   private TypeAdapter<Number> doubleAdapter(boolean serializeSpecialFloatingPointValues) {\n         .toString();\n   }\n \n-  private final Set<TypeAdapter<?>> generatedTypeAdapters = new HashSet<TypeAdapter<?>>();\n   public static final class $$Internal {\n     public static void addGeneratedTypeAdapter(Gson gson, TypeAdapter<?> typeAdapter) {\n-      gson.generatedTypeAdapters.add(typeAdapter);\n+      if (gson.inConstructorPhase) {\n+        gson.preconfiguredGeneratedTypeAdapters.add(typeAdapter);\n+      } else {\n+        Set<TypeAdapter<?>> adapters = getRuntimeGeneratedTypeAdapters(gson);\n+        adapters.add(typeAdapter);\n+      }\n     }\n     public static boolean isGeneratedTypeAdapter(Gson gson, TypeAdapter<?> typeAdapter) {\n-      return gson.generatedTypeAdapters.contains(typeAdapter);\n+      boolean generated = gson.preconfiguredGeneratedTypeAdapters.contains(typeAdapter);\n+      if (!generated) generated = getRuntimeGeneratedTypeAdapters(gson).contains(typeAdapter);\n+      return generated;\n+    }\n+    private static Set<TypeAdapter<?>> getRuntimeGeneratedTypeAdapters(Gson gson) {\n+      Set<TypeAdapter<?>> adapters = gson.runtimeGeneratedTypeAdapters.get();\n+      if (adapters == null) adapters = new HashSet<TypeAdapter<?>>();\n+      gson.runtimeGeneratedTypeAdapters.set(adapters);\n+      return adapters;\n     }\n   }\n }", "timestamp": 1394406053, "metainfo": ""}