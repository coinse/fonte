{"sha": "67d512ee7db6eca139622591cd7ea5e46fa39c01", "log": "Created a JsonAdapter annotation that can be applied to classes to indicate their TypeAdapter.", "commit": "\n--- a/gson/src/main/java/com/google/gson/Gson.java\n+++ b/gson/src/main/java/com/google/gson/Gson.java\n import com.google.gson.internal.bind.CollectionTypeAdapterFactory;\n import com.google.gson.internal.bind.DateTypeAdapter;\n import com.google.gson.internal.bind.FieldTypeAdapterFactory;\n+import com.google.gson.internal.bind.JsonAdapterAnnotationTypeAdapterFactory;\n import com.google.gson.internal.bind.JsonTreeReader;\n import com.google.gson.internal.bind.JsonTreeWriter;\n import com.google.gson.internal.bind.MapTypeAdapterFactory;\n     // type adapters for composite and user-defined types\n     factories.add(new CollectionTypeAdapterFactory(constructorConstructor));\n     factories.add(new MapTypeAdapterFactory(constructorConstructor, complexMapKeySerialization));\n+    factories.add(new JsonAdapterAnnotationTypeAdapterFactory(constructorConstructor));\n     factories.add(new FieldTypeAdapterFactory());\n     factories.add(new ReflectiveTypeAdapterFactory(\n         constructorConstructor, fieldNamingPolicy, excluder));\n--- /dev/null\n+++ b/gson/src/main/java/com/google/gson/annotations/JsonAdapter.java\n+/*\n+ * Copyright (C) 2014 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.gson.annotations;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+import com.google.gson.TypeAdapter;\n+\n+/**\n+ * An annotation that indicates the Gson {@link TypeAdapter} to use with a class or a field.\n+ * Any type adapters registered in {@link com.google.gson.GsonBuilder} supersede the adapter\n+ * specified in this annotation.\n+ *\n+ * <p>Here is an example of how this annotation is used:</p>\n+ * <pre>\n+ * &#64JsonAdapter(UserJsonAdapter.class)\n+ * public class User {\n+ *   public final String firstName, lastName;\n+ *   private User(String firstName, String lastName) {\n+ *     this.firstName = firstName;\n+ *     this.lastName = lastName;\n+ *   }\n+ * }\n+ * public class UserJsonAdapter extends TypeAdapter&lt;User&gt; {\n+ *   &#64Override public void write(JsonWriter out, User user) throws IOException {\n+ *     // implement write: combine firstName and lastName into name\n+ *     out.beginObject();\n+ *     out.name(\"name\");\n+ *     out.value(user.firstName + \" \" + user.lastName);\n+ *     out.endObject();\n+ *     // implement the write method\n+ *   }\n+ *   &#64Override public User read(JsonReader in) throws IOException {\n+ *     // implement read: split name into firstName and lastName\n+ *     in.beginObject();\n+ *     in.nextName();\n+ *     String[] nameParts = in.nextString().split(\" \");\n+ *     in.endObject();\n+ *     return new User(nameParts[0], nameParts[1]);\n+ *   }\n+ * }\n+ * </pre>\n+ *\n+ * Since User class specified UserJsonAdapter.class in &#64JsonAdapter annotation, it\n+ * will automatically be invoked to serialize/deserialize User instances.\n+ *\n+ * If the UserJsonAdapter needs a constructor other than a no-args constructor, you must register\n+ * an {@link com.google.gson.InstanceCreator} for it.\n+ * \n+ * @since 2.3\n+ *\n+ * @author Inderjeet Singh\n+ * @author Joel Leitch\n+ * @author Jesse Leitch\n+ */\n+// Note that the above example is taken from JsonAdapterANnotationTest.\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target(ElementType.TYPE)\n+public @interface JsonAdapter {\n+\n+  Class<? extends TypeAdapter<?>> value();\n+\n+}\n--- /dev/null\n+++ b/gson/src/main/java/com/google/gson/internal/bind/JsonAdapterAnnotationTypeAdapterFactory.java\n+/*\n+ * Copyright (C) 2014 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.gson.internal.bind;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.TypeAdapter;\n+import com.google.gson.TypeAdapterFactory;\n+import com.google.gson.annotations.JsonAdapter;\n+import com.google.gson.internal.ConstructorConstructor;\n+import com.google.gson.internal.ObjectConstructor;\n+import com.google.gson.reflect.TypeToken;\n+\n+/**\n+ * Given a type T, looks for the annotation {@link JsonAdapter} and uses an instance of the\n+ * specified class as the default type adapter.\n+ *\n+ * @since 2.3\n+ */\n+public final class JsonAdapterAnnotationTypeAdapterFactory implements TypeAdapterFactory {\n+\n+  private final ConstructorConstructor constructorConstructor;\n+\n+  public JsonAdapterAnnotationTypeAdapterFactory(ConstructorConstructor constructorConstructor) {\n+    this.constructorConstructor = constructorConstructor;\n+  }\n+\n+  @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+  public <T> TypeAdapter<T> create(Gson gson, TypeToken<T> targetType) {\n+    Class<? super T> clazz = targetType.getRawType();\n+    JsonAdapter annotation = clazz.getAnnotation(JsonAdapter.class);\n+    if (annotation == null) return null;\n+    Class<? extends TypeAdapter<?>> adapterClass = annotation.value();\n+    ObjectConstructor<? extends TypeAdapter<?>> constructor = constructorConstructor.get(TypeToken.get(adapterClass));\n+    TypeAdapter adapter = constructor.construct();\n+    return adapter;\n+  }\n+}\n--- /dev/null\n+++ b/gson/src/test/java/com/google/gson/functional/JsonAdapterAnnotationTest.java\n+/*\n+ * Copyright (C) 2014 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.gson.functional;\n+\n+import java.io.IOException;\n+import java.lang.reflect.Type;\n+\n+import junit.framework.TestCase;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonDeserializationContext;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParseException;\n+import com.google.gson.JsonPrimitive;\n+import com.google.gson.JsonSerializationContext;\n+import com.google.gson.JsonSerializer;\n+import com.google.gson.TypeAdapter;\n+import com.google.gson.annotations.JsonAdapter;\n+import com.google.gson.stream.JsonReader;\n+import com.google.gson.stream.JsonWriter;\n+\n+/**\n+ * Functional tests for the {@link com.google.gson.annotations.JsonAdapter} annotation.\n+ */\n+public final class JsonAdapterAnnotationTest extends TestCase {\n+\n+  public void testJsonAdapterInvoked() {\n+    Gson gson = new Gson();\n+    String json = gson.toJson(new A(\"bar\"));\n+    assertEquals(\"\\\"jsonAdapter\\\"\", json);\n+\n+   // Also invoke the JsonAdapter javadoc sample\n+    json = gson.toJson(new User(\"Inderjeet\", \"Singh\"));\n+    assertEquals(\"{\\\"name\\\":\\\"Inderjeet Singh\\\"}\", json);\n+    User user = gson.fromJson(\"{'name':'Joel Leitch'}\", User.class);\n+    assertEquals(\"Joel\", user.firstName);\n+    assertEquals(\"Leitch\", user.lastName);\n+  }\n+\n+  public void testRegisteredAdapterOverridesJsonAdapter() {\n+    TypeAdapter<A> typeAdapter = new TypeAdapter<A>() {\n+      @Override public void write(JsonWriter out, A value) throws IOException {\n+        out.value(\"registeredAdapter\");\n+      }\n+      @Override public A read(JsonReader in) throws IOException {\n+        return new A(in.nextString());\n+      }\n+    };\n+    Gson gson = new GsonBuilder()\n+      .registerTypeAdapter(A.class, typeAdapter)\n+      .create();\n+    String json = gson.toJson(new A(\"abcd\"));\n+    assertEquals(\"\\\"registeredAdapter\\\"\", json);\n+  }\n+\n+  /**\n+   * The serializer overrides field adapter, but for deserializer the fieldAdapter is used.\n+   */\n+  public void testRegisteredSerializerOverridesJsonAdapter() {\n+    JsonSerializer<A> serializer = new JsonSerializer<A>() {\n+      public JsonElement serialize(A src, Type typeOfSrc,\n+          JsonSerializationContext context) {\n+        return new JsonPrimitive(\"registeredSerializer\");\n+      }\n+    };\n+    Gson gson = new GsonBuilder()\n+      .registerTypeAdapter(A.class, serializer)\n+      .create();\n+    String json = gson.toJson(new A(\"abcd\"));\n+    assertEquals(\"\\\"registeredSerializer\\\"\", json);\n+    A target = gson.fromJson(\"abcd\", A.class);\n+    assertEquals(\"jsonAdapter\", target.value);\n+  }\n+\n+  /**\n+   * The deserializer overrides Json adapter, but for serializer the jsonAdapter is used.\n+   */\n+  public void testRegisteredDeserializerOverridesJsonAdapter() {\n+    JsonDeserializer<A> deserializer = new JsonDeserializer<A>() {\n+      public A deserialize(JsonElement json, Type typeOfT,\n+          JsonDeserializationContext context) throws JsonParseException {\n+        return new A(\"registeredDeserializer\");\n+      }\n+    };\n+    Gson gson = new GsonBuilder()\n+      .registerTypeAdapter(A.class, deserializer)\n+      .create();\n+    String json = gson.toJson(new A(\"abcd\"));\n+    assertEquals(\"\\\"jsonAdapter\\\"\", json);\n+    A target = gson.fromJson(\"abcd\", A.class);\n+    assertEquals(\"registeredDeserializer\", target.value);\n+  }\n+\n+  public void testIncorrectTypeAdapterFails() {\n+    try {\n+      String json = new Gson().toJson(new ClassWithIncorrectJsonAdapter(\"bar\"));\n+      fail(json);\n+    } catch (ClassCastException expected) {}\n+  }\n+\n+  public void testSuperclassTypeAdapterNotInvoked() {\n+    String json = new Gson().toJson(new B(\"bar\"));\n+    assertFalse(json.contains(\"jsonAdapter\"));\n+  }\n+\n+  @JsonAdapter(A.JsonAdapter.class)\n+  private static class A {\n+    final String value;\n+    A(String value) {\n+      this.value = value;\n+    }\n+    private static final class JsonAdapter extends TypeAdapter<A> { \n+      @Override public void write(JsonWriter out, A value) throws IOException {\n+        out.value(\"jsonAdapter\");\n+      }\n+      @Override public A read(JsonReader in) throws IOException {\n+        in.nextString();\n+        return new A(\"jsonAdapter\");\n+      }\n+    }\n+  }\n+\n+  private static final class B extends A {\n+    B(String value) {\n+      super(value);\n+    }\n+  }\n+  // Note that the type is NOT TypeAdapter<ClassWithIncorrectJsonAdapter> so this\n+  // should cause error\n+  @JsonAdapter(A.JsonAdapter.class)\n+  private static final class ClassWithIncorrectJsonAdapter {\n+    @SuppressWarnings(\"unused\") final String value;\n+    ClassWithIncorrectJsonAdapter(String value) {\n+      this.value = value;\n+    }\n+  }\n+\n+  // This class is used in JsonAdapter Javadoc as an example\n+  @JsonAdapter(UserJsonAdapter.class)\n+  private static class User {\n+    public final String firstName, lastName;\n+    private User(String firstName, String lastName) {\n+      this.firstName = firstName;\n+      this.lastName = lastName;\n+    }\n+  }\n+  private static class UserJsonAdapter extends TypeAdapter<User> {\n+    @Override public void write(JsonWriter out, User user) throws IOException {\n+      // implement write: combine firstName and lastName into name\n+      out.beginObject();\n+      out.name(\"name\");\n+      out.value(user.firstName + \" \" + user.lastName);\n+      out.endObject();\n+      // implement the write method\n+    }\n+    @Override public User read(JsonReader in) throws IOException {\n+      // implement read: split name into firstName and lastName\n+      in.beginObject();\n+      in.nextName();\n+      String[] nameParts = in.nextString().split(\" \");\n+      in.endObject();\n+      return new User(nameParts[0], nameParts[1]);\n+    }\n+  }\n+\n+}", "timestamp": 1394318239, "metainfo": ""}