{"sha": "20088623b6ea3fe38d4db7567be63ee654fd2c3f", "log": "add an optional NodePointerFactory whose (indirectly) returned PropertyPointers are 'strict' for LazyDynaBeans (JXPathNotFoundException on unset lazy properties)  ", "commit": "\n--- /dev/null\n+++ b/src/java/org/apache/commons/jxpath/ri/model/dynabeans/StrictLazyDynaBeanPointerFactory.java\n+package org.apache.commons.jxpath.ri.model.dynabeans;\n+\n+import java.util.Locale;\n+\n+import org.apache.commons.beanutils.LazyDynaBean;\n+import org.apache.commons.beanutils.LazyDynaClass;\n+import org.apache.commons.jxpath.ri.QName;\n+import org.apache.commons.jxpath.ri.model.NodePointer;\n+import org.apache.commons.jxpath.ri.model.NodePointerFactory;\n+import org.apache.commons.jxpath.ri.model.beans.PropertyPointer;\n+\n+/**\n+ * Implemented in response to [JXPATH-144]. Optionally pluggable\n+ * <code>NodePointerFactory</code> that returns a special type of\n+ * <code>NodePointer</code> for <code>LazyDynaBean</code>s. The\n+ * <code>PropertyPointer</code>s returned by these will respect\n+ * {@link LazyDynaClass#isDynaProperty(String)} when determining\n+ * {@link PropertyPointer#isActual()}\n+ */\n+public class StrictLazyDynaBeanPointerFactory implements NodePointerFactory {\n+    private static class StrictLazyDynaBeanPointer extends DynaBeanPointer {\n+        private static final long serialVersionUID = 1L;\n+\n+        private final LazyDynaBean lazyDynaBean;\n+\n+        /**\n+         * Create a new StrictLazyDynaBeanPointer instance.\n+         * \n+         * @param parent\n+         * @param name\n+         * @param lazyDynaBean\n+         */\n+        public StrictLazyDynaBeanPointer(NodePointer parent, QName name, LazyDynaBean lazyDynaBean) {\n+            super(parent, name, lazyDynaBean);\n+            this.lazyDynaBean = lazyDynaBean;\n+        }\n+\n+        /**\n+         * Create a new StrictLazyDynaBeanPointer instance.\n+         * \n+         * @param name\n+         * @param lazyDynaBean\n+         * @param locale\n+         */\n+        public StrictLazyDynaBeanPointer(QName name, LazyDynaBean lazyDynaBean, Locale locale) {\n+            super(name, lazyDynaBean, locale);\n+            this.lazyDynaBean = lazyDynaBean;\n+        }\n+\n+        public PropertyPointer getPropertyPointer() {\n+            return new DynaBeanPropertyPointer(this, lazyDynaBean) {\n+                private static final long serialVersionUID = 1L;\n+\n+                protected boolean isActualProperty() {\n+                    return ((LazyDynaClass) lazyDynaBean.getDynaClass())\n+                            .isDynaProperty(getPropertyName());\n+                }\n+            };\n+        }\n+    }\n+\n+    public int getOrder() {\n+        return DynaBeanPointerFactory.DYNA_BEAN_POINTER_FACTORY_ORDER - 1;\n+    }\n+\n+    public NodePointer createNodePointer(QName name, Object object, Locale locale) {\n+        return object instanceof LazyDynaBean ? new StrictLazyDynaBeanPointer(name,\n+                (LazyDynaBean) object, locale) : null;\n+    }\n+\n+    public NodePointer createNodePointer(NodePointer parent, QName name, Object object) {\n+        return object instanceof LazyDynaBean ? new StrictLazyDynaBeanPointer(parent, name,\n+                (LazyDynaBean) object) : null;\n+    }\n+\n+}\n--- /dev/null\n+++ b/src/test/org/apache/commons/jxpath/ri/model/dynabeans/LazyDynaBeanTest.java\n+package org.apache.commons.jxpath.ri.model.dynabeans;\n+\n+import org.apache.commons.beanutils.LazyDynaBean;\n+import org.apache.commons.jxpath.JXPathContext;\n+import org.apache.commons.jxpath.JXPathNotFoundException;\n+import org.apache.commons.jxpath.JXPathTestCase;\n+import org.apache.commons.jxpath.ri.JXPathContextReferenceImpl;\n+\n+public class LazyDynaBeanTest extends JXPathTestCase {\n+\n+    public void testLazyProperty() throws JXPathNotFoundException {\n+        LazyDynaBean bean = new LazyDynaBean();\n+        JXPathContext context = JXPathContext.newContext(bean);\n+        context.getValue(\"nosuch\");\n+    }\n+\n+    public void testStrictLazyDynaBeanPropertyFactory() {\n+        JXPathContextReferenceImpl.addNodePointerFactory(new StrictLazyDynaBeanPointerFactory());\n+        try {\n+            testLazyProperty();\n+            fail();\n+        } catch (JXPathNotFoundException e) {\n+            //okay\n+        }\n+    }\n+}", "timestamp": 1307483275, "metainfo": ""}