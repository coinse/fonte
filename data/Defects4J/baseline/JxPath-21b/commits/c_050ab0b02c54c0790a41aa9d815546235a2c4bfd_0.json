{"sha": "050ab0b02c54c0790a41aa9d815546235a2c4bfd", "log": "simplify and bulletproof cache synchronization; thanks to Sebastian Bazley  ", "commit": "\n--- a/src/java/org/apache/commons/jxpath/FunctionLibrary.java\n+++ b/src/java/org/apache/commons/jxpath/FunctionLibrary.java\n     /**\n      * Prepare the cache.\n      */\n-    private Map functionCache() {\n+    private synchronized Map functionCache() {\n         if (byNamespace == null) {\n-            synchronized (this) {\n-                //read again\n-                if (byNamespace == null) {\n-                    byNamespace = new HashMap();\n-                    int count = allFunctions.size();\n-                    for (int i = 0; i < count; i++) {\n-                        Functions funcs = (Functions) allFunctions.get(i);\n-                        Set namespaces = funcs.getUsedNamespaces();\n-                        for (Iterator it = namespaces.iterator(); it.hasNext();) {\n-                            String ns = (String) it.next();\n-                            Object candidates = byNamespace.get(ns);\n-                            if (candidates == null) {\n-                                byNamespace.put(ns, funcs);\n-                            } else if (candidates instanceof Functions) {\n-                                List lst = new ArrayList();\n-                                lst.add(candidates);\n-                                lst.add(funcs);\n-                                byNamespace.put(ns, lst);\n-                            } else {\n-                                ((List) candidates).add(funcs);\n-                            }\n-                        }\n+            byNamespace = new HashMap();\n+            int count = allFunctions.size();\n+            for (int i = 0; i < count; i++) {\n+                Functions funcs = (Functions) allFunctions.get(i);\n+                Set namespaces = funcs.getUsedNamespaces();\n+                for (Iterator it = namespaces.iterator(); it.hasNext();) {\n+                    String ns = (String) it.next();\n+                    Object candidates = byNamespace.get(ns);\n+                    if (candidates == null) {\n+                        byNamespace.put(ns, funcs);\n+                    } else if (candidates instanceof Functions) {\n+                        List lst = new ArrayList();\n+                        lst.add(candidates);\n+                        lst.add(funcs);\n+                        byNamespace.put(ns, lst);\n+                    } else {\n+                        ((List) candidates).add(funcs);\n                     }\n                 }\n             }", "timestamp": 1307543239, "metainfo": ""}