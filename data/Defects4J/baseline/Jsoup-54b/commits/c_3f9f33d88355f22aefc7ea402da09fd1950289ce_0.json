{"sha": "3f9f33d88355f22aefc7ea402da09fd1950289ce", "log": "Fix issue with UTF-8 BOM when charset only in HTML.  Fixes #348", "commit": "\n--- a/src/main/java/org/jsoup/helper/DataUtil.java\n+++ b/src/main/java/org/jsoup/helper/DataUtil.java\n \n     // reads bytes first into a buffer, then decodes with the appropriate charset. done this way to support\n     // switching the chartset midstream when a meta http-equiv tag defines the charset.\n+    // todo - this is getting gnarly. needs a rewrite.\n     static Document parseByteData(ByteBuffer byteData, String charsetName, String baseUri, Parser parser) {\n         String docData;\n         Document doc = null;\n             doc = parser.parseInput(docData, baseUri);\n             Element meta = doc.select(\"meta[http-equiv=content-type], meta[charset]\").first();\n             if (meta != null) { // if not found, will keep utf-8 as best attempt\n-\n                 String foundCharset;\n                 if (meta.hasAttr(\"http-equiv\")) {\n                     foundCharset = getCharsetFromContentType(meta.attr(\"content\"));\n             Validate.notEmpty(charsetName, \"Must set charset arg to character set of file to parse. Set to null to attempt to detect from HTML\");\n             docData = Charset.forName(charsetName).decode(byteData).toString();\n         }\n+        // UTF-8 BOM indicator. takes precedence over everything else. rarely used. re-decodes incase above decoded incorrectly\n+        if (docData.length() > 0 && docData.charAt(0) == 65279) {\n+            byteData.rewind();\n+            docData = Charset.forName(defaultCharset).decode(byteData).toString();\n+            docData = docData.substring(1);\n+            charsetName = defaultCharset;\n+            doc = null;\n+        }\n         if (doc == null) {\n-            // there are times where there is a spurious byte-order-mark at the start of the text. Shouldn't be present\n-            // in utf-8. If after decoding, there is a BOM, strip it; otherwise will cause the parser to go straight\n-            // into head mode\n-            if (docData.length() > 0 && docData.charAt(0) == 65279)\n-                docData = docData.substring(1);\n-\n             doc = parser.parseInput(docData, baseUri);\n             doc.outputSettings().charset(charsetName);\n         }\n--- a/src/test/java/org/jsoup/helper/DataUtilTest.java\n+++ b/src/test/java/org/jsoup/helper/DataUtilTest.java\n         assertEquals(\"One\", doc.head().text());\n     }\n \n+    @Test public void discardsSpuriousByteOrderMarkWhenNoCharsetSet() {\n+        String html = \"\\uFEFF<html><head><title>One</title></head><body>Two</body></html>\";\n+        ByteBuffer buffer = Charset.forName(\"UTF-8\").encode(html);\n+        Document doc = DataUtil.parseByteData(buffer, null, \"http://foo.com/\", Parser.htmlParser());\n+        assertEquals(\"One\", doc.head().text());\n+        assertEquals(\"UTF-8\", doc.outputSettings().charset().displayName());\n+    }\n+\n     @Test\n     public void shouldNotThrowExceptionOnEmptyCharset() {\n         assertEquals(null, DataUtil.getCharsetFromContentType(\"text/html; charset=\"));", "timestamp": 1384751577, "metainfo": ""}