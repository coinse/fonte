{"sha": "d5d29b625fef0a6b6c69fca9c03330d85de585de", "log": "[COLLECTIONS-445] Several workarounds for IBM JDKs flawed TreeMap.  ", "commit": "\n--- a/src/main/java/org/apache/commons/collections/bidimap/DualTreeBidiMap.java\n+++ b/src/main/java/org/apache/commons/collections/bidimap/DualTreeBidiMap.java\n                 throw new IllegalArgumentException(\n                         \"Cannot use setValue() when the object being set is already in the map\");\n             }\n-            return parent.put(last.getKey(), value);\n+            final V oldValue = parent.put(last.getKey(), value);\n+            // set also the value in the Map.Entry:\n+            // due to a bug in IBM JDK where the Entry is not in sync with the underlying map\n+            last.setValue(value);\n+            return oldValue;\n         }\n \n         public void reset() {\n--- a/src/test/java/org/apache/commons/collections/map/AbstractMapTest.java\n+++ b/src/test/java/org/apache/commons/collections/map/AbstractMapTest.java\n      */\n     private void views() {\n         this.keySet = getMap().keySet();\n-        this.values = getMap().values();\n+        // see verifyValues: retrieve the values collection only when verifying them\n+        // this.values = getMap().values();\n         this.entrySet = getMap().entrySet();\n     }\n \n \n     public void verifyValues() {\n         final List<V> known = new ArrayList<V>(getConfirmed().values());\n+        \n+        // bug in IBM JDK: IBM J9 VM build 2.4, JRE 1.6.0 IBM J9 2.4 Linux x86-32 jvmxi3260sr12-20121024_126067\n+        // a call to values() on an empty map retrieved via TreeMap#headMap or tailMap\n+        // will render the values view unusable: resulting in NullPointExceptions or missing values\n+        // it will also not recover, as the value view is cached internally\n+        values = getMap().values();\n+        \n         final List<V> test = new ArrayList<V>(values);\n \n         final int size = getConfirmed().size();", "timestamp": 1362607073, "metainfo": ""}