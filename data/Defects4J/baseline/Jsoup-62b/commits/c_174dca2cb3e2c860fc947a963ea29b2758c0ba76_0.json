{"sha": "174dca2cb3e2c860fc947a963ea29b2758c0ba76", "log": "Moved charset update settings into Document class and improved tests.", "commit": "\n--- a/src/main/java/org/jsoup/nodes/Document.java\n+++ b/src/main/java/org/jsoup/nodes/Document.java\n     private OutputSettings outputSettings = new OutputSettings();\n     private QuirksMode quirksMode = QuirksMode.noQuirks;\n     private String location;\n+    private boolean updateMetaCharset = false;\n \n     /**\n      Create a new, empty Document.\n     }\n \n     @Override\n-    public String html() {\n-        ensureMetaCharset();\n-        return super.html();\n-    }\n-\n-    @Override\n     public String outerHtml() {\n         return super.html(); // no outer wrapper tag\n     }\n     @Override\n     public String nodeName() {\n         return \"#document\";\n+    }\n+    \n+    public void charset(Charset charset) {\n+        outputSettings.charset(charset);\n+        ensureMetaCharset();\n+    }\n+    \n+    public Charset charset() {\n+        return outputSettings.charset();\n+    }\n+    \n+    public void updateMetaCharset(boolean update) {\n+        this.updateMetaCharset = true;\n+    }\n+    \n+    public boolean updateMetaCharset() {\n+        return updateMetaCharset;\n     }\n \n     @Override\n     }\n     \n     private void ensureMetaCharset() {\n-        if( outputSettings.updateMetaCharset() ) {\n+        if( updateMetaCharset == true ) {\n             Element metaCharset = select(\"meta[charset]\").first();\n             \n             if( metaCharset != null ) {\n         private boolean outline = false;\n         private int indentAmount = 1;\n         private Syntax syntax = Syntax.html;\n-        private boolean updateMetaCharset = false;\n \n         public OutputSettings() {}\n         \n         public OutputSettings indentAmount(int indentAmount) {\n             Validate.isTrue(indentAmount >= 0);\n             this.indentAmount = indentAmount;\n-            return this;\n-        }\n-        \n-        public boolean updateMetaCharset() {\n-            return updateMetaCharset;\n-        }\n-        \n-        public OutputSettings updateMetaCharset(boolean updateMetaCharset) {\n-            this.updateMetaCharset = updateMetaCharset;\n             return this;\n         }\n \n--- a/src/test/java/org/jsoup/nodes/DocumentTest.java\n+++ b/src/test/java/org/jsoup/nodes/DocumentTest.java\n     \n     @Test\n     public void testMetaCharsetUpdate() {\n-        Document doc = Document.createShell(\"\");\n-        doc.head().appendElement(\"meta\").attr(\"charset\", \"changeThis\");\n-        doc.body().appendElement(\"div\").text(\"aaa\");\n-        \n+        // Existing meta charset tag\n+        final Document doc = Document.createShell(\"\");\n+        doc.updateMetaCharset(true);\n+        doc.head().appendElement(\"meta\").attr(\"charset\", \"changeThis\");        \n         \n         final String charsetUtf8 = \"UTF-8\";\n-        doc.outputSettings().charset(charsetUtf8);\n+        doc.charset(Charset.forName(charsetUtf8));\n         Element metaCharset = doc.select(\"meta[charset]\").first();\n         \n-        assertNotNull(metaCharset);\n-        assertEquals(doc.outputSettings().charset().displayName(), charsetUtf8);\n-        assertEquals(metaCharset.attr(\"charset\"), charsetUtf8);\n-        \n+        final String htmlCharsetUTF8 = \"<html>\\n\" +\n+                                        \" <head>\\n\" +\n+                                        \"  <meta charset=\\\"\" + charsetUtf8 + \"\\\">\\n\" +\n+                                        \" </head>\\n\" +\n+                                        \" <body></body>\\n\" +\n+                                        \"</html>\";\n+        \n+        assertNotNull(metaCharset);\n+        assertEquals(charsetUtf8, doc.charset().displayName());\n+        assertEquals(charsetUtf8, metaCharset.attr(\"charset\"));\n+        assertEquals(htmlCharsetUTF8, doc.toString());\n+        assertEquals(doc.charset(), doc.outputSettings().charset());\n         \n         final String charsetIso8859 = \"ISO-8859-1\";\n-        doc.outputSettings().charset(Charset.forName(charsetIso8859));\n+        doc.charset(Charset.forName(charsetIso8859));\n         metaCharset = doc.select(\"meta[charset]\").first();\n         \n-        assertNotNull(metaCharset);\n-        assertEquals(doc.outputSettings().charset().displayName(), charsetIso8859);\n-        assertEquals(metaCharset.attr(\"charset\"), charsetIso8859);\n+        final String htmlCharsetISO = \"<html>\\n\" +\n+                                        \" <head>\\n\" +\n+                                        \"  <meta charset=\\\"\" + charsetIso8859 + \"\\\">\\n\" +\n+                                        \" </head>\\n\" +\n+                                        \" <body></body>\\n\" +\n+                                        \"</html>\";\n+        \n+        assertNotNull(metaCharset);\n+        assertEquals(charsetIso8859, doc.charset().displayName());\n+        assertEquals(charsetIso8859, metaCharset.attr(\"charset\"));\n+        assertEquals(htmlCharsetISO, doc.toString());\n+        assertEquals(doc.charset(), doc.outputSettings().charset());\n+        \n+        \n+        // No meta charset tag\n+        final Document docNoCharset = Document.createShell(\"\");\n+        docNoCharset.updateMetaCharset(true);\n+        doc.charset(Charset.forName(charsetUtf8));\n+        \n+        assertEquals(charsetUtf8, doc.select(\"meta[charset]\").first().attr(\"charset\"));\n+        assertEquals(htmlCharsetUTF8, doc.toString());\n+        \n+        \n+        // Disabled update of meta charset tag\n+        final Document docDisabled = Document.createShell(\"\");\n+        assertFalse(docDisabled.updateMetaCharset());\n+        \n+        final String htmlNoCharset = \"<html>\\n\" +\n+                                        \" <head></head>\\n\" +\n+                                        \" <body></body>\\n\" +\n+                                        \"</html>\";\n+        \n+        assertEquals(htmlNoCharset, docDisabled.toString());\n+        assertNull(docDisabled.select(\"meta[charset]\").first());\n+        \n+        final String htmlCharset = \"<html>\\n\" +\n+                                    \" <head>\\n\" +\n+                                    \"  <meta charset=\\\"dontTouch\\\">\\n\" +\n+                                    \" </head>\\n\" +\n+                                    \" <body></body>\\n\" +\n+                                    \"</html>\";\n+        \n+        docDisabled.head().appendElement(\"meta\").attr(\"charset\", \"dontTouch\");\n+        assertEquals(htmlCharset, docDisabled.toString());\n+        \n+        metaCharset = docDisabled.select(\"meta[charset]\").first();\n+        assertNotNull(metaCharset);\n+        assertEquals(\"dontTouch\", metaCharset.attr(\"charset\"));\n+        \n+        doc.charset(Charset.forName(charsetUtf8));\n+        metaCharset = docDisabled.select(\"meta[charset]\").first();\n+        assertNotNull(metaCharset);\n+        assertEquals(\"dontTouch\", metaCharset.attr(\"charset\"));\n     }\n }", "timestamp": 1414611753, "metainfo": ""}