{"sha": "4dfc8ed0747f5d7cd10ba35621add0fe4891a545", "log": "SANDBOX-313: Endless loops in CSV parser when last line is comment  ", "commit": "\n--- a/src/java/org/apache/commons/csv/CSVParser.java\n+++ b/src/java/org/apache/commons/csv/CSVParser.java\n     } \n     \n     //  important: make sure a new char gets consumed in each iteration\n-    while (!tkn.isReady) {\n+    while (!tkn.isReady && tkn.type != TT_EOF) {\n       // ignore whitespaces at beginning of a token\n       while (strategy.getIgnoreLeadingWhitespaces() && isWhitespace(c) && !eol) {\n         wsBuf.append((char) c);\n--- a/src/test/org/apache/commons/csv/CSVParserTest.java\n+++ b/src/test/org/apache/commons/csv/CSVParserTest.java\n     String[][] res = {\n         { \"a\", \"b\" },\n         { \"\\n\", \" \" },\n-        { \"\", \"#\" },    // WARNING: TODO: this causes a hang if comments are enabled\n+        { \"\", \"#\" },\n     };\n \n     CSVStrategy strategy = CSVStrategy.DEFAULT_STRATEGY;\n     assertTrue(tmp.length > 0);\n \n     if (!CSVPrinterTest.equals(res, tmp)) {\n+      assertTrue(false);\n+    }\n+\n+    String[][] res_comments = {\n+        { \"a\", \"b\" },\n+        { \"\\n\", \" \" },\n+        { \"\"},\n+    };\n+\n+    strategy = new CSVStrategy(',','\"','#');\n+    parser = new CSVParser(new StringReader(code), strategy);\n+    tmp = parser.getAllValues();\n+\n+    if (!CSVPrinterTest.equals(res_comments, tmp)) {\n       assertTrue(false);\n     }\n   }\n--- a/src/test/org/apache/commons/csv/CSVPrinterTest.java\n+++ b/src/test/org/apache/commons/csv/CSVPrinterTest.java\n   }\n \n   public static boolean equals(String[][] a, String[][] b) {\n+    if (a.length != b.length) {\n+      return false;\n+    }\n     for (int i=0; i<a.length; i++) {\n       String[] linea = a[i];\n       String[] lineb = b[i];\n+      if (linea.length != lineb.length) {\n+        return false;\n+      }\n       for (int j=0; j<linea.length; j++) {\n         String aval = linea[j];\n         String bval = lineb[j];", "timestamp": 1279157575, "metainfo": ""}