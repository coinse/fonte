{"sha": "73b52d0d995b8c6091c0e92f8ada03a2753b576a", "log": "Dedupe elements by identity, not equality  Fixed #614", "commit": "\n--- a/src/main/java/org/jsoup/select/Selector.java\n+++ b/src/main/java/org/jsoup/select/Selector.java\n import org.jsoup.helper.Validate;\n import org.jsoup.nodes.Element;\n \n+import java.util.ArrayList;\n import java.util.Collection;\n-import java.util.LinkedHashSet;\n+import java.util.IdentityHashMap;\n \n /**\n  * CSS-like element selector, that finds elements matching a query.\n         Validate.notEmpty(query);\n         Validate.notNull(roots);\n         Evaluator evaluator = QueryParser.parse(query);\n-        LinkedHashSet<Element> elements = new LinkedHashSet<Element>();\n+        ArrayList<Element> elements = new ArrayList<Element>();\n+        IdentityHashMap<Element, Boolean> seenElements = new IdentityHashMap<Element, Boolean>();\n+        // dedupe elements by identity, not equality\n \n         for (Element root : roots) {\n-            elements.addAll(select(evaluator, root));\n+            final Elements found = select(evaluator, root);\n+            for (Element el : found) {\n+                if (!seenElements.containsKey(el)) {\n+                    elements.add(el);\n+                    seenElements.put(el, Boolean.TRUE);\n+                }\n+            }\n         }\n         return new Elements(elements);\n     }\n--- a/src/test/java/org/jsoup/select/SelectorTest.java\n+++ b/src/test/java/org/jsoup/select/SelectorTest.java\n         found = doc.select(\"div[class=\\\"value\\\\ \\\"]\");\n         assertEquals(0, found.size());\n     }\n-    \n+\n+    @Test public void selectSameElements() {\n+        final String html = \"<div>one</div><div>one</div>\";\n+\n+        Document doc = Jsoup.parse(html);\n+        Elements els = doc.select(\"div\");\n+        assertEquals(2, els.size());\n+\n+        Elements subSelect = els.select(\":contains(one)\");\n+        assertEquals(2, subSelect.size());\n+    }\n }", "timestamp": 1440967495, "metainfo": ""}