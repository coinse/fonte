{"sha": "8ec29562144187ccea0c2ceb3bee08d2e9e720bc", "log": "First pass at a local test server", "commit": "\n--- /dev/null\n+++ b/src/test/java/org/jsoup/integration/ConnectTest.java\n+package org.jsoup.integration;\n+\n+import org.jsoup.Jsoup;\n+import org.jsoup.integration.servlets.HelloServlet;\n+import org.jsoup.nodes.Document;\n+import org.jsoup.nodes.Element;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class ConnectTest {\n+\n+    @BeforeClass public static void setUp() throws Exception {\n+        TestServer.start();\n+    }\n+\n+    @AfterClass public static void tearDown() throws Exception {\n+        TestServer.stop();\n+    }\n+\n+    @Test public void canConnectToLocalServer() throws IOException {\n+        String url = HelloServlet.Url;\n+        Document doc = Jsoup.connect(url).get();\n+        Element p = doc.selectFirst(\"p\");\n+        assertEquals(\"Hello, World!\", p.text());\n+    }\n+}\n--- /dev/null\n+++ b/src/test/java/org/jsoup/integration/TestServer.java\n+package org.jsoup.integration;\n+\n+import org.eclipse.jetty.server.Server;\n+import org.eclipse.jetty.server.ServerConnector;\n+import org.eclipse.jetty.servlet.ServletHandler;\n+import org.jsoup.integration.servlets.BaseServlet;\n+\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+public class TestServer {\n+    private static final Server jetty = new Server(0);\n+    private static final ServletHandler handler = new ServletHandler();\n+    private static AtomicInteger latch = new AtomicInteger(0);\n+\n+    static {\n+        jetty.setHandler(handler);\n+        start();\n+    }\n+\n+    private TestServer() {\n+    }\n+\n+    static void start() {\n+        synchronized (jetty) {\n+            int count = latch.getAndIncrement();\n+            if (count == 0) {\n+                try {\n+                    jetty.start();\n+                } catch (Exception e) {\n+                    throw new IllegalStateException(e);\n+                }\n+            }\n+        }\n+    }\n+\n+    static void stop() {\n+        synchronized (jetty) {\n+            int count = latch.decrementAndGet();\n+            if (count == 0) {\n+                try {\n+                    jetty.stop();\n+                } catch (Exception e) {\n+                    throw new IllegalStateException(e);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static String map(Class<? extends BaseServlet> servletClass) {\n+        synchronized (jetty) {\n+            String path = \"/\" + servletClass.getSimpleName();\n+            handler.addServletWithMapping(servletClass, path);\n+            int port = ((ServerConnector) jetty.getConnectors()[0]).getLocalPort();\n+            return \"http://localhost:\" + port + path;\n+        }\n+    }\n+}\n--- /dev/null\n+++ b/src/test/java/org/jsoup/integration/servlets/BaseServlet.java\n+package org.jsoup.integration.servlets;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServlet;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+\n+public abstract class BaseServlet extends HttpServlet {\n+    static final String TextHtml = \"text/html\";\n+\n+    @Override\n+    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {\n+        super.doGet(req, res);\n+    }\n+}\n--- /dev/null\n+++ b/src/test/java/org/jsoup/integration/servlets/HelloServlet.java\n+package org.jsoup.integration.servlets;\n+\n+import org.jsoup.integration.TestServer;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+\n+public class HelloServlet extends BaseServlet {\n+    public static final String Url = TestServer.map(HelloServlet.class);\n+\n+    @Override\n+    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {\n+        res.setContentType(TextHtml);\n+        res.setStatus(HttpServletResponse.SC_OK);\n+\n+        String doc = \"<p>Hello, World!\";\n+        res.getWriter().write(doc);\n+    }\n+}", "timestamp": 1508017483, "metainfo": ""}