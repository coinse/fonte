{"sha": "da9547ebcd83525723fca18997a5a7e058c9796f", "log": "Update charset of meta tag.", "commit": "\n--- a/src/main/java/org/jsoup/nodes/Document.java\n+++ b/src/main/java/org/jsoup/nodes/Document.java\n \n  @author Jonathan Hedley, jonathan@hedley.net */\n public class Document extends Element {\n-    private OutputSettings outputSettings = new OutputSettings();\n+    private OutputSettings outputSettings = new OutputSettings(this);\n     private QuirksMode quirksMode = QuirksMode.noQuirks;\n     private String location;\n \n         private boolean outline = false;\n         private int indentAmount = 1;\n         private Syntax syntax = Syntax.html;\n-\n-        public OutputSettings() {}\n+        private Document document;\n+\n+        public OutputSettings() {\n+            this(null);\n+        }\n+        \n+        OutputSettings(Document doc) {\n+            this.document = doc;\n+        }\n \n         /**\n          * Get the document's current HTML escape mode: <code>base</code>, which provides a limited set of named HTML\n          * @return the document's output settings, for chaining\n          */\n         public OutputSettings charset(Charset charset) {\n-            // todo: this should probably update the doc's meta charset\n+            if( document != null ) {\n+                Element meta = document.select(\"meta[charset]\").first();\n+                \n+                if( meta != null ) {\n+                    meta.attr(\"charset\", charset.displayName());\n+                }\n+            }\n+            \n             this.charset = charset;\n             charsetEncoder = charset.newEncoder();\n             return this;\n--- a/src/test/java/org/jsoup/nodes/DocumentTest.java\n+++ b/src/test/java/org/jsoup/nodes/DocumentTest.java\n \n import java.io.File;\n import java.io.IOException;\n+import java.nio.charset.Charset;\n \n import org.jsoup.Jsoup;\n import org.jsoup.TextUtil;\n         Document doc = Jsoup.parse(builder.toString());\n         doc.clone();\n     }\n+    \n+    @Test\n+    public void testMetaCharsetUpdate()\n+    {\n+        Document doc = Document.createShell(\"\");\n+        doc.head().appendElement(\"meta\").attr(\"charset\", \"changeThis\");\n+        doc.body().appendElement(\"div\").text(\"aaa\");\n+        \n+        \n+        final String charsetUtf8 = \"UTF-8\";\n+        doc.outputSettings().charset(charsetUtf8);\n+        Element metaCharset = doc.select(\"meta[charset]\").first();\n+        \n+        assertNotNull(metaCharset);\n+        assertEquals(doc.outputSettings().charset().displayName(), charsetUtf8);\n+        assertEquals(metaCharset.attr(\"charset\"), charsetUtf8);\n+        \n+        \n+        final String charsetIso8859 = \"ISO-8859-1\";\n+        doc.outputSettings().charset(Charset.forName(charsetIso8859));\n+        metaCharset = doc.select(\"meta[charset]\").first();\n+        \n+        assertNotNull(metaCharset);\n+        assertEquals(doc.outputSettings().charset().displayName(), charsetIso8859);\n+        assertEquals(metaCharset.attr(\"charset\"), charsetIso8859);\n+    }\n }", "timestamp": 1414415674, "metainfo": ""}